<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetak Kartu Peserta (Deploy Ready)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* ================================================= */
        /* 1. TAMPILAN LAYAR (SCREEN VIEW)                   */
        /* ================================================= */
        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #525659;
            margin: 0; padding: 20px 0;
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; text-align: center; 
        }

        /* PANEL KONTROL RESPONSIF */
        .control-panel {
            background: #fff; 
            width: 215mm; 
            max-width: 95%; /* AGAR MUNCUL DI HP */
            margin: 0 auto 20px auto;
            padding: 15px 20px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,.3); text-align: left;
            box-sizing: border-box;
            border: 1px solid #ddd; /* Border halus untuk kepastian visual */
        }

        /* AREA PILIHAN - HORIZONTAL SCROLL */
        #shift-container {
            border: 1px solid #ddd; padding: 8px; background: #fafafa; margin-bottom: 12px; 
            display: flex; flex-flow: column wrap; 
            height: 85px; 
            overflow-x: auto; overflow-y: hidden; gap: 0 15px; 
            align-content: flex-start; /* Fix untuk Safari/Mobile */
        }
        #shift-container::-webkit-scrollbar { height: 6px; }
        #shift-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        
        .cb-item { 
            font-size: 12px; cursor: pointer; display: flex; align-items: center; 
            gap: 6px; height: 26px; min-width: 150px; flex-shrink: 0; white-space: nowrap;
        }

        .btn-generate { 
            width: 100%; padding: 12px; font-weight: bold; font-size: 14px;
            background: #28a745; color: #fff; border: none; 
            cursor: pointer; border-radius: 4px; text-transform: uppercase; transition: 0.3s;
        }
        .btn-generate:hover { background: #218838; }

        .page-label {
            display: inline-block; background-color: #222; color: #fff;
            padding: 4px 12px; border-radius: 4px; font-size: 13px; font-weight: bold;
            margin-top: 10px; margin-bottom: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 10;
        }

        /* KANVAS KERTAS F4 */
        .page-container {
            background-color: white; width: 215mm; height: 330mm; 
            margin: 0 auto 15px auto; box-shadow: 0 4px 8px rgba(0,0,0,0.3); box-sizing: border-box;
            display: grid; grid-template-columns: 85mm 85mm; grid-template-rows: repeat(3, auto);
            justify-content: center; align-content: start; padding-top: 2mm;
            column-gap: 10mm; row-gap: 1px;      
            page-break-after: always; position: relative; text-align: left; 
            /* Sembunyikan jika di HP agar tidak horizontal scroll parah */
            max-width: 100%; overflow-x: auto;
        }

        /* ================================================= */
        /* 2. TAMPILAN CETAK (PRINT VIEW)                    */
        /* ================================================= */
        @page { size: 215mm 330mm; margin: 0; }

        @media print {
            body { background-color: white; padding: 0; display: block; text-align: left; }
            .control-panel, .page-label { display: none !important; }
            .page-container { margin: 0; box-shadow: none; border: none; page-break-after: always; overflow: visible; }
            .nomor-urut-box {
                background-color: #FFC000 !important;
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important;         
            }
        }

        /* ================================================= */
        /* 3. DESAIN KARTU                                   */
        /* ================================================= */
        .kartu-peserta {
            width: 85mm; height: 108mm; 
            border: 2px solid #000; background: white;
            display: flex; flex-direction: column;
            box-sizing: border-box; position: relative; overflow: hidden;
        }
        .header {
            display: flex; align-items: center; justify-content: space-between;
            height: 14.3mm; border-bottom: 3px double #000; padding: 0 2px; box-sizing: border-box;
        }
        .logo-box { width: 13mm; height: 100%; display: flex; align-items: center; justify-content: center; }
        .logo-box img { max-height: 90%; max-width: 100%; }
        .title-box { flex: 1; text-align: center; font-family: 'Times New Roman', Times, serif; font-weight: bold; font-size: 10pt; line-height: 1.1; }
        .nomor-urut-box {
            width: 13mm; height: 80%; background-color: #FFC000;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 12pt; font-family: 'OCR-A BT', 'Courier New', Courier, monospace;
            border: 1px solid #000;
        }
        .body-upper { display: flex; height: 53mm; border-bottom: 1px solid #000; box-sizing: border-box; }
        .foto-container { width: 39.6mm; height: 100%; display: flex; justify-content: center; align-items: center; border-right: 1px solid #000; box-sizing: border-box; }
        .foto-box { width: 30mm; height: 40mm; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid #ccc; }
        .foto-box img { width: 100%; height: 100%; object-fit: cover; }
        .qr-container { width: 45.4mm; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: start; padding-top: 5px; box-sizing: border-box; }
        .scan-text { color: #007bff; font-family: Arial, sans-serif; font-size: 9pt; text-decoration: underline; margin-bottom: 1.2em; }
        .qr-canvas { width: 32mm; height: 32mm; display: flex; justify-content: center; }
        .id-text { font-family: 'Courier New', Courier, monospace; font-weight: bold; font-size: 10pt; margin-top: auto; margin-bottom: 5px; }
        .nama-container {
            width: 100%; height: 12mm; display: flex; align-items: center; justify-content: center;
            text-align: center; border-bottom: 1px solid #000;
            font-family: 'Arial Narrow', Arial, sans-serif; font-weight: bold; font-size: 12pt;
            text-transform: uppercase; padding: 0 5px; box-sizing: border-box;
        }
        .table-container { width: 100%; flex: 1; box-sizing: border-box; }
        table { width: 100%; height: 100%; border-collapse: collapse; font-family: Arial, sans-serif; font-size: 10pt; }
        table tr td:first-child { border-left: none; }
        table tr td:last-child { border-right: none; }
        table tr:last-child td { border-bottom: none; }
        td { border: 1px solid #000; padding: 0 5px; vertical-align: middle; box-sizing: border-box; }
        .col-label { width: 31mm; text-align: left; }
        .col-val { width: 54mm; text-transform: uppercase; text-align: left; }
    </style>
</head>
<body>

    <div class="control-panel">
        <h3 style="margin: 0 0 5px 0; font-size: 18px;">KARTU PESERTA ukuran B3 (F4/6)</h3>
        <p style="font-size: 11px; color: #666; margin: 0 0 10px 0;">Pilih Gelombang & Shift (Scroll ke samping jika banyak):</p>
        
        <div id="shift-container" style="display:flex; align-items:center; justify-content:center; color:#666; font-style:italic;">
            Sedang memuat data dari Google Sheets...
        </div>
        
        <button class="btn-generate" onclick="generate()">GENERATE KARTU</button>
    </div>

    <div id="main-output"></div>

    <script>
        const SHEET_ID = '1eIcvIgCLWG3F9jQdsw5XN9llOsK2PoYWKUg1qaQJyyA';
        const SHEET_NAME = 'Biodata Cek'; // Nama Sheet Asli
        const LOGO_FILENAME = "QIRAATI.png"; 

        // FIX 1: Encode URI Component untuk menangani spasi pada nama sheet
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`; 

        let groupedData = {}; 
        const mainOutput = document.getElementById('main-output');

        // --- INIT: LOAD DATA SAAT DOM SIAP ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const csvText = await response.text();
                
                // Cek jika response adalah HTML (biasanya karena sheet privat/salah URL)
                if(csvText.trim().startsWith("<!DOCTYPE html>")) {
                    throw new Error("Gagal akses. Pastikan Sheet 'Siapa saja yang memiliki link' sudah aktif.");
                }

                processDataForPanel(csvText);
            } catch (error) {
                const errBox = document.getElementById('shift-container');
                errBox.style.color = 'red';
                errBox.innerHTML = `<strong>Error:</strong> ${error.message}<br><small>Cek console untuk detail.</small>`;
                console.error(error);
            }
        });

        function processDataForPanel(csvText) {
            const rows = csvText.trim().split('\n').filter(r => r.trim().length > 0);
            if (rows.length < 2) {
                document.getElementById('shift-container').innerText = "Data Kosong atau Format Salah.";
                return;
            }
            
            const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, '').toUpperCase());
            groupedData = {};
            
            for (let i = 1; i < rows.length; i++) {
                const rowData = rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                let p = {};
                rowData.forEach((val, idx) => { p[headers[idx]] = val ? val.trim().replace(/"/g, '') : ''; });
                
                // Gunakan default '?' jika kosong agar tidak crash
                const gel = p['GELOMBANG'] || '?';
                const sft = p['SHIFT'] || '?';
                const key = `${gel}-${sft}`;
                
                if (!groupedData[key]) groupedData[key] = [];
                groupedData[key].push(p);
            }

            const container = document.getElementById('shift-container');
            container.innerHTML = ''; 
            // Reset style container agar checkbox bisa flow
            container.style.display = 'flex';
            container.style.alignItems = 'flex-start';
            container.style.justifyContent = 'flex-start';
            container.style.fontStyle = 'normal';
            
            Object.keys(groupedData).sort().forEach(k => {
                const count = groupedData[k].length;
                const label = document.createElement('label');
                label.className = 'cb-item';
                const displayKey = k.replace('-', ' - SFT ');
                label.innerHTML = `<input type="checkbox" name="chk-shift" value="${k}"> Gel ${displayKey} (${count})`;
                container.appendChild(label);
            });
        }

        function generate() {
            const selectedCheckboxes = document.querySelectorAll('input[name="chk-shift"]:checked');
            if (selectedCheckboxes.length === 0) return alert("Pilih minimal satu Gelombang/Shift!");

            mainOutput.innerHTML = ''; 
            let filteredParticipants = [];
            selectedCheckboxes.forEach(cb => {
                const key = cb.value;
                if(groupedData[key]) filteredParticipants = filteredParticipants.concat(groupedData[key]);
            });

            // Sortir Nomor Urut
            filteredParticipants.sort((a, b) => parseInt(a['NOMOR'] || 0) - parseInt(b['NOMOR'] || 0));

            renderPages(filteredParticipants);
        }

        function renderPages(participants) {
            const ITEMS_PER_PAGE = 6; 
            const totalPages = Math.ceil(participants.length / ITEMS_PER_PAGE);
            let currentPageDiv = createNewPage();
            let pageIndex = 1;

            participants.forEach((data, index) => {
                if (index > 0 && index % ITEMS_PER_PAGE === 0) {
                    appendPageWithLabel(currentPageDiv, pageIndex, totalPages);
                    pageIndex++;
                    currentPageDiv = createNewPage();
                }
                const cardElement = createCardHTML(data);
                currentPageDiv.appendChild(cardElement);
                setTimeout(() => { generateQRCode(data['ID PENDAFTARAN'], `qrcode-${data['NOMOR']}`); }, 10);
            });

            if (currentPageDiv.hasChildNodes()) appendPageWithLabel(currentPageDiv, pageIndex, totalPages);
        }

        function appendPageWithLabel(container, current, total) {
            const label = document.createElement('div');
            label.className = 'page-label';
            label.innerText = `HALAMAN ${current} DARI ${total}`;
            mainOutput.appendChild(label);
            mainOutput.appendChild(container);
        }

        function createNewPage() {
            const div = document.createElement('div');
            div.className = 'page-container';
            return div;
        }

        function createCardHTML(data) {
            const card = document.createElement('div');
            card.className = 'kartu-peserta';
            
            const NO_URUT = String(data['NOMOR'] || '000').padStart(3, '0');
            const ABSEN = data['ID PENDAFTARAN'] || '-';
            const NAMA = (data['NAMA LENGKAP (SESUAI AKTA)'] || '-').toUpperCase();
            const LEMBAGA = (data['ASAL LEMBAGA / TPQ'] || '-');
            const BIN = (data['NAMA AYAH'] || '-').toUpperCase();
            const BINTI = (data['NAMA IBU'] || '-').toUpperCase();
            
            const rawFoto = data['KIRIM PAS FOTO UKURAN POSTCARD'] || '';
            const FOTO_URL = getDirectDriveUrl(rawFoto);
            
            const rawTempat = data['TEMPAT LAHIR'] || '';
            const rawTanggal = data['TANGGAL LAHIR'] || '';
            const tempatFormatted = toTitleCase(rawTempat);
            const tanggalFormatted = formatTanggalIndo(rawTanggal);
            const TTL = (tempatFormatted && tanggalFormatted) ? `${tempatFormatted}, ${tanggalFormatted}` : '-';

            card.innerHTML = `
                <div class="header">
                    <div class="logo-box"><img src="${LOGO_FILENAME}" alt="Logo" onerror="this.style.display='none'"></div>
                    <div class="title-box">EVALUASI BELAJAR<br>TAHAP AKHIR QIROATI<br>(EBTAQ)</div>
                    <div class="nomor-urut-box">${NO_URUT}</div>
                </div>
                <div class="body-upper">
                    <div class="foto-container">
                        <div class="foto-box">
                            <img src="${FOTO_URL}" onerror="this.style.display='none'; this.parentNode.innerText='NO FOTO'">
                        </div>
                    </div>
                    <div class="qr-container">
                        <div class="scan-text">Scan di sini!</div>
                        <div id="qrcode-${data['NOMOR']}" class="qr-canvas"></div>
                        <div class="id-text">${ABSEN}</div>
                    </div>
                </div>
                <div class="nama-container">${NAMA}</div>
                <div class="table-container">
                    <table cellspacing="0">
                        <tr><td class="col-label">Tpt. Tgl. Lahir</td><td class="col-val" style="text-transform: none;">${TTL}</td></tr>
                        <tr><td class="col-label">Nama Ayah</td><td class="col-val">${BIN}</td></tr>
                        <tr><td class="col-label">Nama Ibu</td><td class="col-val">${BINTI}</td></tr>
                        <tr><td class="col-label">Lembaga / TKQ</td><td class="col-val">${LEMBAGA}</td></tr>
                    </table>
                </div>
            `;
            return card;
        }

        function generateQRCode(text, elementId) {
            const el = document.getElementById(elementId);
            if(el) {
                el.innerHTML = "";
                new QRCode(el, { text: text || "NO DATA", width: 120, height: 120, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
            }
        }
        function toTitleCase(str) { return str.replace(/\w\S*/g, function(txt){ return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase(); }); }
        function formatTanggalIndo(dateStr) {
            if (!dateStr) return '';
            const bulanIndo = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];
            let d, m, y;
            const matchSlash = dateStr.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
            if (matchSlash) { d = parseInt(matchSlash[1]); m = parseInt(matchSlash[2]) - 1; y = matchSlash[3]; } 
            else { const dateObj = new Date(dateStr); if (!isNaN(dateObj)) { d = dateObj.getDate(); m = dateObj.getMonth(); y = dateObj.getFullYear(); } else { return dateStr; } }
            if (m >= 0 && m < 12) { return `${d} ${bulanIndo[m]} ${y}`; }
            return dateStr;
        }

        // FIX 2: FORCE HTTPS untuk Google Drive Images agar tidak kena Mixed Content
        function getDirectDriveUrl(url) {
            if (!url) return '';
            const matchId = url.match(/id=([a-zA-Z0-9_-]+)/);
            // Menggunakan HTTPS
            if (matchId && matchId[1]) return `https://lh3.googleusercontent.com/d/${matchId[1]}`;
            return url;
        }
    </script>
</body>
</html>

