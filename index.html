<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kartu EBTAQ Final | Origin Logic</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* --- TAMPILAN PANEL (FITRI) --- */
        body { font-family: Arial, sans-serif; background-color: #525659; margin: 0; padding: 20px 0; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .control-panel { background: #fff; width: 215mm; max-width: 95%; margin: 0 auto 20px auto; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,.3); text-align: left; box-sizing: border-box; }
        #shift-container { border: 1px solid #ddd; padding: 8px; background: #fafafa; margin-bottom: 12px; display: flex; flex-flow: column wrap; height: 85px; overflow-x: auto; gap: 0 15px; align-content: flex-start; }
        .cb-item { font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; height: 26px; min-width: 150px; flex-shrink: 0; white-space: nowrap; }
        .btn-generate { width: 100%; padding: 12px; font-weight: bold; background: #28a745; color: #fff; border: none; cursor: pointer; border-radius: 4px; }
        .page-label { display: inline-block; background-color: #222; color: #fff; padding: 4px 12px; border-radius: 4px; font-size: 13px; margin-top: 10px; margin-bottom: 5px; }

        /* --- LAYOUT KERTAS (ORIGIN MODIFIED) --- */
        .page-container {
            background-color: white; width: 215mm; height: 330mm; margin: 0 auto 15px auto; box-sizing: border-box;
            display: grid;
            grid-template-columns: 85mm 85mm; 
            grid-template-rows: repeat(3, 107mm); /* Tinggi kartu 107mm */
            justify-content: center; align-content: start;
            padding-top: 4mm; /* Jarak aman atas 4mm */
            column-gap: 10mm; 
            row-gap: 1px; /* Jarak antar kartu sesuai Origin */
            page-break-after: always; position: relative; text-align: left; overflow: hidden;
        }

        @page { size: 215mm 330mm; margin: 0; }
        @media print {
            body { background-color: white; padding: 0; }
            .control-panel, .page-label { display: none !important; }
            .page-container { margin: 0; box-shadow: none; display: grid !important; }
            .nomor-urut-box { background-color: #FFC000 !important; -webkit-print-color-adjust: exact; }
        }

        /* --- DESAIN KARTU (MURNI ORIGIN) --- */
        .kartu-peserta { width: 85mm; height: 107mm; border: 2px solid #000; background: white; display: flex; flex-direction: column; box-sizing: border-box; overflow: hidden; }
        .header { display: flex; align-items: center; justify-content: space-between; height: 14.3mm; border-bottom: 3px double #000; padding: 0 2px; }
        .logo-box { width: 13mm; display: flex; align-items: center; justify-content: center; }
        .logo-box img { max-height: 90%; max-width: 100%; }
        .title-box { flex: 1; text-align: center; font-family: 'Times New Roman', serif; font-weight: bold; font-size: 10pt; line-height: 1.1; }
        .nomor-urut-box { width: 13mm; height: 80%; background-color: #FFC000; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12pt; border: 1px solid #000; }
        
        /* Area Foto QR dikurangi 1mm menjadi 52mm */
        .body-upper { display: flex; height: 52mm; border-bottom: 1px solid #000; }
        .foto-container { width: 39.6mm; display: flex; justify-content: center; align-items: center; border-right: 1px solid #000; }
        .foto-box { width: 30mm; height: 40mm; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 1px solid #ccc; }
        .foto-box img { width: 100%; height: 100%; object-fit: cover; }
        .qr-container { width: 45.4mm; display: flex; flex-direction: column; align-items: center; padding-top: 5px; }
        .scan-text { color: #007bff; font-size: 9pt; text-decoration: underline; margin-bottom: 1.2em; }
        .id-text { font-family: monospace; font-weight: bold; font-size: 10pt; margin-top: auto; margin-bottom: 5px; }
        .nama-container { width: 100%; height: 12mm; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #000; font-weight: bold; font-size: 12pt; text-transform: uppercase; }
        .table-container { width: 100%; flex: 1; }
        table { width: 100%; height: 100%; border-collapse: collapse; font-size: 10pt; }
        td { border: 1px solid #000; padding: 0 5px; }
        .col-label { width: 31mm; }
    </style>
</head>
<body>

    <div class="control-panel">
        <h3 style="margin:0 0 5px 0">Panel Kontrol â€“ Cetak Kartu EBTAQ</h3>
        <div id="shift-container">Memuat data...</div>
        <button class="btn-generate" onclick="generate()">GENERATE KARTU</button>
    </div>

    <div id="main-output"></div>

<script>
    const SHEET_ID = '1eIcvIgCLWG3F9jQdsw5XN9llOsK2PoYWKUg1qaQJyyA';
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/' + SHEET_ID + '/gviz/tq?tqx=out:csv&sheet=Biodata Cek';
    const LOGO_FILENAME = "QIRAATI.png";
    let groupedData = {};

    function toTitleCase(str) { return str ? str.replace(/\w\S*/g, function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()}) : ''; }
    
    function formatTanggalIndo(dateStr) {
        if (!dateStr) return '';
        const bulan = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];
        const m = dateStr.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
        if (m) { return m[1] + ' ' + bulan[parseInt(m[2])-1] + ' ' + m[3]; }
        return dateStr;
    }

    // --- LOGIKA PANGGIL FOTO (ORIGIN - TANPA SIMBOL $) ---
    function getDirectDriveUrl(url) {
        if (!url) return '';
        const matchId = url.match(/[-\w]{25,}/); 
        if (matchId) {
            // Menggunakan penggabungan tanda plus (+) untuk menghindari masalah simbol $
            return "https://lh3.googleusercontent.com/d/$" + matchId[0];
        }
        return url;
    }

    window.onload = async () => {
        try {
            const res = await fetch(SHEET_URL);
            const csv = await res.text();
            process(csv);
        } catch (e) { document.getElementById('shift-container').innerText = "Gagal memuat."; }
    };

    function process(csv) {
        const rows = csv.trim().split('\n');
        const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, '').toUpperCase());
        groupedData = {};
        for (let i = 1; i < rows.length; i++) {
            const cols = rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
            let p = {};
            cols.forEach((v, j) => { p[headers[j]] = v ? v.trim().replace(/"/g, '') : ''; });
            const key = (p['GELOMBANG'] || '?') + '-' + (p['SHIFT'] || '?');
            if (!groupedData[key]) groupedData[key] = [];
            groupedData[key].push(p);
        }
        const container = document.getElementById('shift-container');
        container.innerHTML = '';
        Object.keys(groupedData).sort().forEach(k => {
            const label = document.createElement('label');
            label.className = 'cb-item';
            label.innerHTML = '<input type="checkbox" name="chk-shift" value="' + k + '"> Gel ' + k.replace('-', ' - SFT ') + ' (' + groupedData[k].length + ')';
            container.appendChild(label);
        });
    }

    function generate() {
        const sel = document.querySelectorAll('input[name="chk-shift"]:checked');
        if (sel.length === 0) return alert("Pilih minimal satu!");
        const out = document.getElementById('main-output');
        out.innerHTML = '';
        let filtered = [];
        sel.forEach(cb => { filtered = filtered.concat(groupedData[cb.value]); });
        filtered.sort((a, b) => parseInt(a['NOMOR'] || 0) - parseInt(b['NOMOR'] || 0));
        render(filtered);
    }

    function render(data) {
        const perPage = 6;
        const total = Math.ceil(data.length / perPage);
        for (let i = 0; i < total; i++) {
            const label = document.createElement('div');
            label.className = 'page-label';
            label.innerText = 'HALAMAN ' + (i + 1) + ' DARI ' + total;
            document.getElementById('main-output').appendChild(label);
            const page = document.createElement('div');
            page.className = 'page-container';
            const start = i * perPage;
            const end = Math.min(start + perPage, data.length);
            for (let j = start; j < end; j++) {
                page.appendChild(createCard(data[j], j));
                setTimeout(() => { 
                    const el = document.getElementById('qrcode-' + j);
                    if(el) new QRCode(el, { text: data[j]['ID PENDAFTARAN'] || 'N/A', width: 120, height: 120 });
                }, 50);
            }
            document.getElementById('main-output').appendChild(page);
        }
    }

    function createCard(p, idx) {
        const card = document.createElement('div');
        card.className = 'kartu-peserta';
        const TTL = toTitleCase(p['TEMPAT LAHIR']) + ', ' + formatTanggalIndo(p['TANGGAL LAHIR']);
        const FOTO = getDirectDriveUrl(p['KIRIM PAS FOTO UKURAN POSTCARD']);
        card.innerHTML = `
            <div class="header">
                <div class="logo-box"><img src="${LOGO_FILENAME}" onerror="this.style.display='none'"></div>
                <div class="title-box">EVALUASI BELAJAR<br>TAHAP AKHIR QIROATI<br>(EBTAQ)</div>
                <div class="nomor-urut-box">${String(p['NOMOR'] || '0').padStart(3, '0')}</div>
            </div>
            <div class="body-upper">
                <div class="foto-container"><div class="foto-box"><img src="${FOTO}" onerror="this.style.display='none'; this.parentNode.innerText='NO FOTO'"></div></div>
                <div class="qr-container"><div class="scan-text">Scan di sini!</div><div id="qrcode-${idx}" style="width:32mm; height:32mm; display:flex; justify-content:center;"></div><div class="id-text">${p['ID PENDAFTARAN'] || '-'}</div></div>
            </div>
            <div class="nama-container">${(p['NAMA LENGKAP (SESUAI AKTA)'] || '-').toUpperCase()}</div>
            <div class="table-container">
                <table>
                    <tr><td class="col-label">Tpt. Tgl. Lahir</td><td style="text-transform:none">${TTL}</td></tr>
                    <tr><td class="col-label">Nama Ayah</td><td>${(p['NAMA AYAH'] || '-').toUpperCase()}</td></tr>
                    <tr><td class="col-label">Nama Ibu</td><td>${(p['NAMA IBU'] || '-').toUpperCase()}</td></tr>
                    <tr><td class="col-label">Lembaga / TKQ</td><td>${p['ASAL LEMBAGA / TPQ'] || '-'}</td></tr>
                </table>
            </div>`;
        return card;
    }
</script>
</body>
</html>
