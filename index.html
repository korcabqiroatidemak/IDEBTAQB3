<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetak ID Card B3 (4 per Halaman)</title>
    <style>
        /* ================================================= */
        /* 1. Reset & Page Setup (A4) */
        /* ================================================= */
        @page {
            size: A4 portrait; /* Kertas A4 Tegak */
            margin: 1cm;       /* Margin aman printer */
        }
        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #eee;
            -webkit-print-color-adjust: exact; /* Agar background warna tecetak */
            print-color-adjust: exact;
        }

        /* ================================================= */
        /* 2. Container Halaman (Grid 2x2) */
        /* ================================================= */
        .page-container {
            background-color: white;
            width: 21cm;        /* Lebar A4 */
            height: 29.7cm;     /* Tinggi A4 */
            padding: 1cm;       
            margin: 20px auto;
            box-sizing: border-box;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
            
            /* GRID: 2 Kolom x 2 Baris = 4 Kartu B3 */
            display: grid;
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: 1fr 1fr; 
            gap: 15px; /* Jarak potong antar kartu */
            align-content: start;
            
            page-break-after: always;
        }

        /* ================================================= */
        /* 3. Desain Kartu B3 (9.5cm x 12.4cm) */
        /* ================================================= */
        .kartu-b3 {
            width: 9.5cm;   /* Lebar standar B3 Portrait */
            height: 12.4cm; /* Tinggi disesuaikan agar muat 2 baris */
            border: 2px solid #333; /* Garis tepi tebal */
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            box-sizing: border-box;
        }

        /* HEADER KARTU */
        .card-header {
            background-color: #006400; /* Hijau Tua (Ganti jika perlu) */
            color: white;
            text-align: center;
            padding: 8px 0;
            border-bottom: 2px solid #004d00;
        }
        .card-header h2 {
            margin: 0;
            font-size: 14pt;
            text-transform: uppercase;
        }
        .card-header p {
            margin: 2px 0 0;
            font-size: 9pt;
            font-weight: normal;
        }

        /* BODY KARTU */
        .card-body {
            padding: 10px;
            flex: 1;
            display: flex;
            align-items: flex-start; /* Rata atas */
            font-size: 11pt; /* Font lebih besar untuk B3 */
        }

        /* FOTO (KIRI) */
        .foto-area {
            width: 3cm;         /* Lebar Tetap 3cm */
            height: 4cm;        /* Rasio 3x4 */
            background-color: #f0f0f0;
            border: 1px solid #999;
            margin-right: 10px;
            flex-shrink: 0;     /* Jangan mengecil */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .foto-area img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* DATA (KANAN) */
        .info-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px; /* Jarak antar baris data */
        }
        
        .row-data {
            display: flex;
            line-height: 1.3;
        }
        .label {
            width: 60px; /* Lebar label */
            font-weight: bold;
            font-size: 10pt;
            flex-shrink: 0;
        }
        .separator {
            width: 10px;
            text-align: center;
            flex-shrink: 0;
        }
        .value {
            font-size: 10pt; /* Isi Data */
            word-wrap: break-word; /* Bungkus teks panjang */
        }

        /* FOOTER / TTD AREA */
        .card-footer {
            text-align: center;
            padding-bottom: 10px;
            font-size: 10pt;
        }
        .ttd-box {
            height: 40px; /* Ruang TTD */
        }

        /* ================================================= */
        /* 4. Mode Cetak */
        /* ================================================= */
        @media print {
            body { background-color: white; }
            .page-container {
                margin: 0;
                box-shadow: none;
                border: none;
                height: 100vh;
            }
            #loading { display: none; }
        }
    </style>
</head>
<body>

    <div id="loading" style="text-align: center; margin-top: 50px; font-family: sans-serif;">
        <h3>Memuat data ID Card B3...</h3>
    </div>
    
    <div id="main-output"></div>

    <script>
        // --- KONFIGURASI ---
        const SHEET_ID = '1eIcvIgCLWG3F9jQdsw5XN9llOsK2PoYWKUg1qaQJyyA';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Form Responses 1`; 

        const mainOutput = document.getElementById('main-output');
        const loading = document.getElementById('loading');

        // --- Helper: Fix Google Drive URL ---
        function getDirectDriveUrl(url) {
            if (!url) return '';
            const matchId = url.match(/id=([a-zA-Z0-9_-]+)/);
            if (matchId && matchId[1]) return `https://lh3.googleusercontent.com/d/${matchId[1]}`;
            return url;
        }

        // --- Fetch Data ---
        async function fetchSheetData() {
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) throw new Error("Gagal ambil data");
                const csvText = await response.text();
                loading.style.display = 'none';
                processCSV(csvText);
            } catch (error) {
                loading.innerText = 'Error: ' + error.message;
            }
        }

        // --- Process CSV ---
        function processCSV(csvText) {
            const rows = csvText.trim().split('\n').filter(r => r.trim().length > 0);
            if (rows.length < 2) return;

            const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const allParticipants = [];

            // Parsing Data
            for (let i = 1; i < rows.length; i++) {
                const rowData = rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                let p = { 'NO': i + 1 };
                rowData.forEach((val, idx) => {
                    p[headers[idx]] = val ? val.trim().replace(/"/g, '') : '';
                });
                allParticipants.push(p);
            }

            // --- PAGINATION: 4 KARTU PER HALAMAN (A4) ---
            const ITEMS_PER_PAGE = 4;
            let currentPageDiv = createNewPage();

            allParticipants.forEach((data, index) => {
                if (index > 0 && index % ITEMS_PER_PAGE === 0) {
                    mainOutput.appendChild(currentPageDiv);
                    currentPageDiv = createNewPage();
                }
                currentPageDiv.appendChild(createCardHTML(data));
            });

            // Append halaman terakhir
            if (currentPageDiv.hasChildNodes()) {
                mainOutput.appendChild(currentPageDiv);
            }
        }

        // Buat Halaman Baru
        function createNewPage() {
            const div = document.createElement('div');
            div.className = 'page-container';
            return div;
        }

        // Buat HTML Kartu B3
        function createCardHTML(data) {
            const card = document.createElement('div');
            card.className = 'kartu-b3';

            // Ambil Data
            const ABSEN = data['ID Pendaftaran'] || '-';
            const NAMA = (data['Nama Lengkap (Sesuai Akta)'] || '-').toUpperCase();
            const LEMBAGA = (data['Asal Lembaga / TPQ'] || '-').toUpperCase();
            const TTL = (data['Tempat Lahir'] || '') + ', ' + (data['Tanggal Lahir'] || '');
            const JK = data['Jenis Kelamin'] || '-';
            const BIN = (data['Nama Ayah'] || '-').toUpperCase();
            const BINTI = (data['Nama Ibu'] || '-').toUpperCase();
            
            const rawFoto = data['Kirim Pas Foto Ukuran PostCard'] || '';
            const FOTO_URL = getDirectDriveUrl(rawFoto);

            // --- TEMPLATE KARTU B3 ---
            card.innerHTML = `
                <div class="card-header">
                    <h2>PESERTA EBTAQ</h2>
                    <p>TAHUN 1446 H / 2025 M</p>
                </div>

                <div class="card-body">
                    <div class="foto-area">
                         <img src="${FOTO_URL}" 
                              onerror="this.style.display='none'; this.parentNode.innerText='NO FOTO'"
                         >
                    </div>
                    <div class="info-area">
                        <div class="row-data">
                            <span class="label">ID</span><span class="separator">:</span>
                            <span class="value">${ABSEN}</span>
                        </div>
                        <div class="row-data">
                            <span class="label">NAMA</span><span class="separator">:</span>
                            <span class="value"><b>${NAMA}</b></span>
                        </div>
                        <div class="row-data">
                            <span class="label">LEMB.</span><span class="separator">:</span>
                            <span class="value">${LEMBAGA}</span>
                        </div>
                        <div class="row-data">
                            <span class="label">TTL</span><span class="separator">:</span>
                            <span class="value">${TTL}</span>
                        </div>
                        <div class="row-data">
                            <span class="label">JK</span><span class="separator">:</span>
                            <span class="value">${JK}</span>
                        </div>
                        <div class="row-data">
                            <span class="label">BIN</span><span class="separator">:</span>
                            <span class="value">${BIN}</span>
                        </div>
                        <div class="row-data">
                            <span class="label">BINTI</span><span class="separator">:</span>
                            <span class="value">${BINTI}</span>
                        </div>
                    </div>
                </div>

                <div class="card-footer">
                    <div class="ttd-box"></div>
                    <p style="margin:0;">Ketua Panitia</p>
                </div>
            `;
            return card;
        }

        // Jalankan
        fetchSheetData();
    </script>
</body>
</html>