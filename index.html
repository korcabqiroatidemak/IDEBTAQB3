<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetak Kartu Peserta - 1 F4 / 6 B3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* ================================================= */
        /* 1. TAMPILAN LAYAR (SCREEN VIEW)                   */
        /* ================================================= */
        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #525659;
            margin: 0; padding: 20px 0;
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; text-align: center; 
        }

        .control-panel {
            background: #fff; width: 215mm; max-width: 95%;
            margin: 0 auto 20px auto; padding: 15px 20px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,.3); text-align: left;
            box-sizing: border-box; border: 1px solid #ddd;
        }

        #shift-container {
            border: 1px solid #ddd; padding: 8px; background: #fafafa; margin-bottom: 12px; 
            display: flex; flex-flow: column wrap; height: 85px; 
            overflow-x: auto; overflow-y: hidden; gap: 0 15px; 
            align-content: flex-start;
        }

        #shift-container::-webkit-scrollbar { height: 6px; }
        #shift-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        
        .cb-item { 
            font-size: 12px; cursor: pointer; display: flex; align-items: center; 
            gap: 6px; height: 26px; min-width: 150px; flex-shrink: 0; white-space: nowrap;
        }

        .btn-generate { 
            width: 100%; padding: 12px; font-weight: bold; font-size: 14px;
            background: #28a745; color: #fff; border: none; 
            cursor: pointer; border-radius: 4px; text-transform: uppercase;
        }

        .page-label {
            display: inline-block; background-color: #222; color: #fff;
            padding: 4px 12px; border-radius: 4px; font-size: 13px; font-weight: bold;
            margin-top: 10px; margin-bottom: 5px; z-index: 10;
        }

        /* ================================================= */
        /* 2. KANVAS KERTAS F4 (AUTO CENTER LOGIC)           */
        /* ================================================= */
        .page-container {
            background-color: white; 
            width: 215mm; 
            height: 330mm; 
            margin: 0 auto 15px auto; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); 
            box-sizing: border-box;
            
            /* LOGI CENTER: Membagi sisa 6mm menjadi 3mm atas & 3mm bawah */
            display: flex;
            flex-wrap: wrap;
            align-content: center;    /* Center Vertikal */
            justify-content: center;  /* Center Horizontal */
            
            column-gap: 10mm; 
            row-gap: 0px;             /* Menghilangkan celah antar baris agar presisi */
            
            page-break-after: always; 
            position: relative; 
            text-align: left; 
            overflow: hidden;
        }

        /* ================================================= */
        /* 3. TAMPILAN CETAK (PRINT VIEW)                    */
        /* ================================================= */
        @page { size: 215mm 330mm; margin: 0; }

        @media print {
            body { background-color: white; padding: 0; display: block; text-align: left; }
            .control-panel, .page-label { display: none !important; }
            .page-container { margin: 0; box-shadow: none; border: none; display: flex !important; }
            .nomor-urut-box {
                background-color: #FFC000 !important;
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important;          
            }
        }

        /* DESAIN KARTU */
        .kartu-peserta {
            width: 85mm; height: 108mm; 
            border: 1px solid #000; background: white;
            display: flex; flex-direction: column;
            box-sizing: border-box; position: relative;
        }
        .header {
            display: flex; align-items: center; justify-content: space-between;
            height: 14.3mm; border-bottom: 3px double #000; padding: 0 2px; box-sizing: border-box;
        }
        .logo-box { width: 13mm; display: flex; align-items: center; justify-content: center; }
        .logo-box img { max-height: 12mm; max-width: 100%; }
        .title-box { flex: 1; text-align: center; font-family: 'Times New Roman', serif; font-weight: bold; font-size: 10pt; line-height: 1.1; }
        .nomor-urut-box {
            width: 13mm; height: 10mm; background-color: #FFC000;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 12pt; border: 1px solid #000;
        }
        .body-upper { display: flex; height: 53mm; border-bottom: 1px solid #000; }
        .foto-container { width: 39.6mm; display: flex; justify-content: center; align-items: center; border-right: 1px solid #000; }
        .foto-box { width: 30mm; height: 40mm; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid #ccc; }
        .foto-box img { width: 100%; height: 100%; object-fit: cover; }
        .qr-container { width: 45.4mm; display: flex; flex-direction: column; align-items: center; padding-top: 5px; }
        .scan-text { color: #007bff; font-size: 9pt; text-decoration: underline; margin-bottom: 5px; }
        .id-text { font-family: monospace; font-weight: bold; font-size: 10pt; margin-top: 5px; }
        .nama-container {
            width: 100%; height: 12mm; display: flex; align-items: center; justify-content: center;
            text-align: center; border-bottom: 1px solid #000; font-weight: bold; font-size: 12pt; text-transform: uppercase;
        }
        .table-container { width: 100%; flex: 1; }
        table { width: 100%; height: 100%; border-collapse: collapse; font-size: 10pt; }
        td { border: 1px solid #000; padding: 0 5px; }
        .col-label { width: 31mm; }
    </style>
</head>
<body>

    <div class="control-panel">
        <h3 style="margin: 0 0 5px 0;">Panel Kontrol â€“ Cetak Kartu EBTAQ</h3>
        <div id="shift-container">Memuat data Google Sheets...</div>
        <button class="btn-generate" onclick="generate()">GENERATE KARTU</button>
    </div>

    <div id="main-output"></div>

    <script>
        const SHEET_ID = '1eIcvIgCLWG3F9jQdsw5XN9llOsK2PoYWKUg1qaQJyyA';
        const SHEET_NAME = 'Biodata Cek';
        const LOGO_FILENAME = "QIRAATI.png"; 
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`; 

        let groupedData = {}; 

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(SHEET_URL);
                const csvText = await response.text();
                processDataForPanel(csvText);
            } catch (error) {
                console.error("Gagal memuat data:", error);
            }
        });

        function processDataForPanel(csvText) {
            const rows = csvText.trim().split('\n');
            const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, '').toUpperCase());
            groupedData = {};
            for (let i = 1; i < rows.length; i++) {
                const rowData = rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                let p = {};
                rowData.forEach((val, idx) => { p[headers[idx]] = val ? val.trim().replace(/"/g, '') : ''; });
                const key = `${p['GELOMBANG'] || '?'}-${p['SHIFT'] || '?'}`;
                if (!groupedData[key]) groupedData[key] = [];
                groupedData[key].push(p);
            }
            const container = document.getElementById('shift-container');
            container.innerHTML = '';
            Object.keys(groupedData).sort().forEach(k => {
                const label = document.createElement('label');
                label.className = 'cb-item';
                label.innerHTML = `<input type="checkbox" name="chk-shift" value="${k}"> Gel ${k.replace('-', ' - SFT ')} (${groupedData[k].length})`;
                container.appendChild(label);
            });
        }

        function generate() {
            const selected = document.querySelectorAll('input[name="chk-shift"]:checked');
            if (selected.length === 0) return alert("Pilih minimal satu Gelombang/Shift!");
            const mainOutput = document.getElementById('main-output');
            mainOutput.innerHTML = ''; 
            let filtered = [];
            selected.forEach(cb => { filtered = filtered.concat(groupedData[cb.value]); });
            filtered.sort((a, b) => parseInt(a['NOMOR'] || 0) - parseInt(b['NOMOR'] || 0));
            renderPages(filtered);
        }

        function renderPages(participants) {
            const perPage = 6;
            const totalPages = Math.ceil(participants.length / perPage);
            for (let i = 0; i < totalPages; i++) {
                const label = document.createElement('div');
                label.className = 'page-label';
                label.innerText = `HALAMAN ${i + 1} DARI ${totalPages}`;
                document.getElementById('main-output').appendChild(label);

                const page = document.createElement('div');
                page.className = 'page-container';
                const start = i * perPage;
                const end = Math.min(start + perPage, participants.length);
                for (let j = start; j < end; j++) {
                    page.appendChild(createCardHTML(participants[j]));
                    setTimeout(() => { generateQRCode(participants[j]['ID PENDAFTARAN'], `qrcode-${participants[j]['NOMOR']}`); }, 50);
                }
                document.getElementById('main-output').appendChild(page);
            }
        }

        function createCardHTML(data) {
            const card = document.createElement('div');
            card.className = 'kartu-peserta';
            const FOTO_URL = getDirectDriveUrl(data['KIRIM PAS FOTO UKURAN POSTCARD']);
            card.innerHTML = `
                <div class="header">
                    <div class="logo-box"><img src="${LOGO_FILENAME}" onerror="this.style.display='none'"></div>
                    <div class="title-box">EVALUASI BELAJAR<br>TAHAP AKHIR QIROATI<br>(EBTAQ)</div>
                    <div class="nomor-urut-box">${String(data['NOMOR'] || '0').padStart(3, '0')}</div>
                </div>
                <div class="body-upper">
                    <div class="foto-container"><div class="foto-box"><img src="${FOTO_URL}" onerror="this.style.display='none'; this.parentNode.innerText='NO FOTO'"></div></div>
                    <div class="qr-container">
                        <div class="scan-text">Scan di sini!</div>
                        <div id="qrcode-${data['NOMOR']}" style="width:30mm; height:30mm;"></div>
                        <div class="id-text">${data['ID PENDAFTARAN'] || '-'}</div>
                    </div>
                </div>
                <div class="nama-container">${(data['NAMA LENGKAP (SESUAI AKTA)'] || '-').toUpperCase()}</div>
                <div class="table-container">
                    <table cellspacing="0">
                        <tr><td class="col-label">Nama Ayah</td><td>${(data['NAMA AYAH'] || '-').toUpperCase()}</td></tr>
                        <tr><td class="col-label">Nama Ibu</td><td>${(data['NAMA IBU'] || '-').toUpperCase()}</td></tr>
                        <tr><td class="col-label">Lembaga</td><td>${data['ASAL LEMBAGA / TPQ'] || '-'}</td></tr>
                    </table>
                </div>`;
            return card;
        }

        function generateQRCode(text, id) {
            const el = document.getElementById(id);
            if(el) new QRCode(el, { text: text || "N/A", width: 110, height: 110 });
        }

        function getDirectDriveUrl(url) {
            if (!url) return '';
            const matchId = url.match(/id=([a-zA-Z0-9_-]+)/);
            // Tetap menggunakan format yang Anda yakini berhasil
            if (matchId && matchId[1]) return `https://lh3.googleusercontent.com/d/$${matchId[1]}`;
            return url;
        }
    </script>
</body>
</html>
