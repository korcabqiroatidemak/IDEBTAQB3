<script>
        const SHEET_ID = '1eIcvIgCLWG3F9jQdsw5XN9llOsK2PoYWKUg1qaQJyyA';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Form Responses 1`; 
        
        // --- PENGATURAN LOGO (Cukup ubah di sini saja) ---
        // Pastikan nama file ini SAMA PERSIS dengan yang diupload di GitHub (huruf besar/kecil)
        const LOGO_FILENAME = "QIRAATI.png"; 

        const mainOutput = document.getElementById('main-output');
        const loading = document.getElementById('loading');

        function getDirectDriveUrl(url) {
            if (!url) return '';
            const matchId = url.match(/id=([a-zA-Z0-9_-]+)/);
            if (matchId && matchId[1]) return `https://lh3.googleusercontent.com/d/${matchId[1]}`;
            return url;
        }

        async function fetchSheetData() {
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) throw new Error("Gagal ambil data");
                const csvText = await response.text();
                loading.style.display = 'none';
                processCSV(csvText);
            } catch (error) {
                loading.innerText = 'Error: ' + error.message;
            }
        }

        function processCSV(csvText) {
            const rows = csvText.trim().split('\n').filter(r => r.trim().length > 0);
            if (rows.length < 2) return;

            const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const allParticipants = [];

            for (let i = 1; i < rows.length; i++) {
                const rowData = rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                let p = { 'NO': i + 1 };
                rowData.forEach((val, idx) => {
                    p[headers[idx]] = val ? val.trim().replace(/"/g, '') : '';
                });
                allParticipants.push(p);
            }

            const ITEMS_PER_PAGE = 4;
            let currentPageDiv = createNewPage();

            allParticipants.forEach((data, index) => {
                if (index > 0 && index % ITEMS_PER_PAGE === 0) {
                    mainOutput.appendChild(currentPageDiv);
                    currentPageDiv = createNewPage();
                }
                
                // Panggil fungsi pembuatan kartu
                const cardElement = createCardHTML(data, index);
                currentPageDiv.appendChild(cardElement);

                // Generate QR Code
                setTimeout(() => {
                    generateQRCode(data['ID Pendaftaran'], `qrcode-${index}`);
                }, 10);
            });

            if (currentPageDiv.hasChildNodes()) {
                mainOutput.appendChild(currentPageDiv);
            }
        }

        function createNewPage() {
            const div = document.createElement('div');
            div.className = 'page-container';
            return div;
        }

        function createCardHTML(data, index) {
            const card = document.createElement('div');
            card.className = 'kartu-peserta';

            const NO_URUT = String(data['NO']).padStart(3, '0');
            const ABSEN = data['ID Pendaftaran'] || '-';
            const NAMA = (data['Nama Lengkap (Sesuai Akta)'] || '-').toUpperCase();
            const LEMBAGA = (data['Asal Lembaga / TPQ'] || '-');
            const TTL = (data['Tempat Lahir'] || '') + ', ' + (data['Tanggal Lahir'] || '');
            const BIN = (data['Nama Ayah'] || '-').toUpperCase();
            const BINTI = (data['Nama Ibu'] || '-').toUpperCase();
            
            const rawFoto = data['Kirim Pas Foto Ukuran PostCard'] || '';
            const FOTO_URL = getDirectDriveUrl(rawFoto);

            // SAYA MENGHAPUS VARIABEL LAMA DI SINI
            // Sekarang langsung memakai LOGO_FILENAME yang dari atas

            card.innerHTML = `
                <div class="header">
                    <div class="logo-box">
                        <img src="${LOGO_FILENAME}" alt="Logo" onerror="this.style.display='none'">
                    </div>
                    <div class="title-box">
                        EVALUASI BELAJAR<br>TAHAP AKHIR QIROATI<br>(EBTAQ)
                    </div>
                    <div class="nomor-urut-box">
                        ${NO_URUT}
                    </div>
                </div>

                <div class="body-upper">
                    <div class="foto-container">
                        <div class="foto-box">
                            <img src="${FOTO_URL}" onerror="this.style.display='none'; this.parentNode.innerText='NO FOTO'">
                        </div>
                    </div>
                    <div class="qr-container">
                        <div class="scan-text">Scan di sini!</div>
                        <div id="qrcode-${index}" class="qr-canvas"></div>
                        <div class="id-text">${ABSEN}</div>
                    </div>
                </div>

                <div class="nama-container">
                    ${NAMA}
                </div>

                <div class="table-container">
                    <table cellspacing="0">
                        <tr>
                            <td class="col-label">Tpt. Tgl. Lahir</td>
                            <td class="col-val">${TTL}</td>
                        </tr>
                        <tr>
                            <td class="col-label">Nama Ayah</td>
                            <td class="col-val">${BIN}</td>
                        </tr>
                        <tr>
                            <td class="col-label">Nama Ibu</td>
                            <td class="col-val">${BINTI}</td>
                        </tr>
                        <tr>
                            <td class="col-label">Lembaga / TKQ</td>
                            <td class="col-val">${LEMBAGA}</td>
                        </tr>
                    </table>
                </div>
            `;
            return card;
        }

        function generateQRCode(text, elementId) {
            const el = document.getElementById(elementId);
            if(el) {
                el.innerHTML = "";
                new QRCode(el, {
                    text: text || "NO DATA",
                    width: 75,
                    height: 75,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
            }
        }

        fetchSheetData();
    </script>
