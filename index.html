<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetak Kartu EBTAQ (F4 Hemat - Single Cut)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* ================================================= */
        /* 1. Page Setup (F4 / Folio) */
        /* ================================================= */
        @page {
            /* F4 Size: 215mm x 330mm */
            size: 215mm 330mm; 
            /* Margin printer minimal (karena area cetak tinggi 32.4cm) */
            margin: 3mm; 
        }
        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #eee;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* ================================================= */
        /* 2. Grid Container (6 Kartu Rapet) */
        /* ================================================= */
        .page-container {
            background-color: white;
            width: 215mm;
            height: 329mm; /* Toleransi 1mm */
            margin: 0 auto;
            box-sizing: border-box;
            
            display: grid;
            grid-template-columns: 1fr 1fr;
            /* 3 Baris */
            grid-template-rows: repeat(3, 1fr); 
            
            justify-items: center; 
            align-items: center;
            
            /* GAP BARIS 0 UNTUK SINGLE CUT */
            column-gap: 1cm; /* Jarak horizontal antar kolom */
            row-gap: 0;      /* Kartu nempel atas-bawah */
            
            page-break-after: always;
        }

        /* ================================================= */
        /* 3. Desain Kartu (Lebar Baru 8.5 cm) */
        /* ================================================= */
        .kartu-peserta {
            width: 8.5cm; /* Lebar dikurangi dari 8.69 ke 8.5 */
            height: 10.8cm; 
            border: 2px solid #000;
            background: white;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }

        /* --- A. HEADER --- */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 1.43cm;
            border-bottom: 3px double #000;
            padding: 0 2px;
            box-sizing: border-box;
        }
        .logo-box {
            width: 1.3cm; 
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logo-box img {
            max-height: 90%;
            max-width: 100%;
        }
        .title-box {
            flex: 1;
            text-align: center;
            font-family: 'Times New Roman', Times, serif;
            font-weight: bold;
            font-size: 10pt;
            line-height: 1.1;
        }
        .nomor-urut-box {
            width: 1.3cm;
            height: 80%;
            background-color: #FFC000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12pt;
            font-family: 'OCR-A BT', 'Courier New', Courier, monospace;
            border: 1px solid #000;
        }

        /* --- B. BODY ATAS (5.3 cm) --- */
        .body-upper {
            display: flex;
            height: 5.3cm; 
            border-bottom: 1px solid #000;
            box-sizing: border-box;
        }
        /* Foto: Lebar dikurangi (4.15 - 0.19 = 3.96cm) */
        .foto-container {
            width: 3.96cm; 
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            border-right: 1px solid #000;
            box-sizing: border-box;
        }
        .foto-box {
            width: 3cm;
            height: 4cm;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid #ccc;
        }
        .foto-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* QR: Lebar Tetap (4.54cm) */
        .qr-container {
            width: 4.54cm;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: start;
            padding-top: 5px; 
            box-sizing: border-box;
        }
        .scan-text {
            color: #007bff;
            font-family: Arial, sans-serif;
            font-size: 9pt;
            text-decoration: underline;
            margin-bottom: 1.2em;
        }
        .qr-canvas {
            width: 3.2cm;
            height: 3.2cm;
            display: flex;
            justify-content: center;
        }
        .id-text {
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            font-size: 10pt;
            margin-top: auto;
            margin-bottom: 5px;
        }

        /* --- C. NAMA (1.2 cm) --- */
        /* Lebar mengikuti kartu (8.5cm) */
        .nama-container {
            width: 100%; 
            height: 1.2cm;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-bottom: 1px solid #000;
            font-family: 'Arial Narrow', Arial, sans-serif;
            font-weight: bold;
            font-size: 12pt;
            text-transform: uppercase;
            padding: 0 5px;
            box-sizing: border-box;
        }

        /* --- D. TABEL DATA --- */
        .table-container {
            width: 100%;
            flex: 1;
            box-sizing: border-box;
        }
        table {
            width: 100%;
            height: 100%;
            border-collapse: collapse;
            font-family: Arial, sans-serif;
            font-size: 10pt;
        }
        /* Hapus border double */
        table tr td:first-child { border-left: none; }
        table tr td:last-child { border-right: none; }
        table tr:last-child td { border-bottom: none; }

        td {
            border: 1px solid #000;
            padding: 0 5px;
            vertical-align: middle;
            box-sizing: border-box;
        }
        .col-label { width: 3.1cm; }
        /* Placeholder value dikurangi lebar */
        .col-val { width: 5.4cm; text-transform: uppercase; }

        @media print {
            body { background-color: white; }
            .page-container {
                margin: 0;
                box-shadow: none;
                border: none;
                height: 100vh;
            }
            #loading { display: none; }
        }
    </style>
</head>
<body>

    <div id="loading" style="text-align: center; margin-top: 50px;">
        <h3>Memuat Data...</h3>
    </div>
    <div id="main-output"></div>

    <script>
        const SHEET_ID = '1eIcvIgCLWG3F9jQdsw5XN9llOsK2PoYWKUg1qaQJyyA';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Form Responses 1`; 
        
        const LOGO_FILENAME = "QIRAATI.png"; 

        const mainOutput = document.getElementById('main-output');
        const loading = document.getElementById('loading');

        // --- Helper: Format Title Case (DEMAK -> Demak) ---
        function toTitleCase(str) {
            return str.replace(/\w\S*/g, function(txt){
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        }

        // --- Helper: Format Tanggal (15/11/2011 -> 15 Nov 2011) ---
        function formatTanggalIndo(dateStr) {
            if (!dateStr) return '';
            
            // Mapping Bulan Pendek
            const bulanIndo = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];
            
            // Cek format umum dd/mm/yyyy atau yyyy-mm-dd
            let d, m, y;
            
            // Regex untuk dd/mm/yyyy atau dd-mm-yyyy
            const matchSlash = dateStr.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
            if (matchSlash) {
                d = parseInt(matchSlash[1]);
                m = parseInt(matchSlash[2]) - 1; // Index array mulai 0
                y = matchSlash[3];
            } else {
                // Coba parse date standar
                const dateObj = new Date(dateStr);
                if (!isNaN(dateObj)) {
                    d = dateObj.getDate();
                    m = dateObj.getMonth();
                    y = dateObj.getFullYear();
                } else {
                    return dateStr; // Jika format tidak dikenali, kembalikan aslinya
                }
            }

            if (m >= 0 && m < 12) {
                return `${d} ${bulanIndo[m]} ${y}`;
            }
            return dateStr;
        }

        function getDirectDriveUrl(url) {
            if (!url) return '';
            const matchId = url.match(/id=([a-zA-Z0-9_-]+)/);
            if (matchId && matchId[1]) return `https://lh3.googleusercontent.com/d/${matchId[1]}`;
            return url;
        }

        async function fetchSheetData() {
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) throw new Error("Gagal ambil data");
                const csvText = await response.text();
                loading.style.display = 'none';
                processCSV(csvText);
            } catch (error) {
                loading.innerText = 'Error: ' + error.message;
            }
        }

        function processCSV(csvText) {
            const rows = csvText.trim().split('\n').filter(r => r.trim().length > 0);
            if (rows.length < 2) return;

            const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const allParticipants = [];

            for (let i = 1; i < rows.length; i++) {
                const rowData = rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                let p = { 'NO': i + 1 };
                rowData.forEach((val, idx) => {
                    p[headers[idx]] = val ? val.trim().replace(/"/g, '') : '';
                });
                allParticipants.push(p);
            }

            const ITEMS_PER_PAGE = 6; 
            let currentPageDiv = createNewPage();

            allParticipants.forEach((data, index) => {
                if (index > 0 && index % ITEMS_PER_PAGE === 0) {
                    mainOutput.appendChild(currentPageDiv);
                    currentPageDiv = createNewPage();
                }
                
                const cardElement = createCardHTML(data, index);
                currentPageDiv.appendChild(cardElement);

                setTimeout(() => {
                    generateQRCode(data['ID Pendaftaran'], `qrcode-${index}`);
                }, 10);
            });

            if (currentPageDiv.hasChildNodes()) {
                mainOutput.appendChild(currentPageDiv);
            }
        }

        function createNewPage() {
            const div = document.createElement('div');
            div.className = 'page-container';
            return div;
        }

        function createCardHTML(data, index) {
            const card = document.createElement('div');
            card.className = 'kartu-peserta';

            const NO_URUT = String(data['NO']).padStart(3, '0');
            const ABSEN = data['ID Pendaftaran'] || '-';
            const NAMA = (data['Nama Lengkap (Sesuai Akta)'] || '-').toUpperCase();
            const LEMBAGA = (data['Asal Lembaga / TPQ'] || '-');
            const BIN = (data['Nama Ayah'] || '-').toUpperCase();
            const BINTI = (data['Nama Ibu'] || '-').toUpperCase();
            const rawFoto = data['Kirim Pas Foto Ukuran PostCard'] || '';
            const FOTO_URL = getDirectDriveUrl(rawFoto);

            // --- FORMATTING TTL ---
            // 1. Ambil data mentah
            const rawTempat = data['Tempat Lahir'] || '';
            const rawTanggal = data['Tanggal Lahir'] || '';
            
            // 2. Format
            const tempatFormatted = toTitleCase(rawTempat); // DEMAK -> Demak
            const tanggalFormatted = formatTanggalIndo(rawTanggal); // 15/11/2011 -> 15 Nov 2011
            
            // 3. Gabung
            const TTL = (tempatFormatted && tanggalFormatted) ? `${tempatFormatted}, ${tanggalFormatted}` : '-';


            card.innerHTML = `
                <div class="header">
                    <div class="logo-box">
                        <img src="${LOGO_FILENAME}" alt="Logo" onerror="this.style.display='none'">
                    </div>
                    <div class="title-box">
                        EVALUASI BELAJAR<br>TAHAP AKHIR QIROATI<br>(EBTAQ)
                    </div>
                    <div class="nomor-urut-box">
                        ${NO_URUT}
                    </div>
                </div>

                <div class="body-upper">
                    <div class="foto-container">
                        <div class="foto-box">
                            <img src="${FOTO_URL}" onerror="this.style.display='none'; this.parentNode.innerText='NO FOTO'">
                        </div>
                    </div>
                    <div class="qr-container">
                        <div class="scan-text">Scan di sini!</div>
                        <div id="qrcode-${index}" class="qr-canvas"></div>
                        <div class="id-text">${ABSEN}</div>
                    </div>
                </div>

                <div class="nama-container">
                    ${NAMA}
                </div>

                <div class="table-container">
                    <table cellspacing="0">
                        <tr>
                            <td class="col-label">Tpt. Tgl. Lahir</td>
                            <td class="col-val">${TTL}</td>
                        </tr>
                        <tr>
                            <td class="col-label">Nama Ayah</td>
                            <td class="col-val">${BIN}</td>
                        </tr>
                        <tr>
                            <td class="col-label">Nama Ibu</td>
                            <td class="col-val">${BINTI}</td>
                        </tr>
                        <tr>
                            <td class="col-label">Lembaga / TKQ</td>
                            <td class="col-val">${LEMBAGA}</td>
                        </tr>
                    </table>
                </div>
            `;
            return card;
        }

        function generateQRCode(text, elementId) {
            const el = document.getElementById(elementId);
            if(el) {
                el.innerHTML = "";
                new QRCode(el, {
                    text: text || "NO DATA",
                    width: 120, 
                    height: 120,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
            }
        }

        fetchSheetData();
    </script>
</body>
</html>
